// Generated by CoffeeScript 1.6.3
(function() {
  window.EasyNote = (function() {
    EasyNote.prototype.WIDTH = (window.innerWidth / 100) * 80;

    EasyNote.prototype.HEIGHT = null;

    EasyNote.prototype.LINE_SPACE = 20;

    EasyNote.prototype.background = null;

    EasyNote.prototype.canvas = null;

    EasyNote.prototype.activateEraser = function() {
      return this.canvas.startErasing();
    };

    EasyNote.prototype.activatePen = function() {
      return this.canvas.startDrawing();
    };

    function EasyNote() {
      this.HEIGHT = Math.floor(this.WIDTH * 1.29411764706);
      this.setupStage();
      this.setupBackground();
      this.setupCanvas();
    }

    EasyNote.prototype.setupStage = function() {
      return this.stage = new Kinetic.Stage({
        container: 'easynote',
        width: this.WIDTH,
        height: this.HEIGHT
      });
    };

    EasyNote.prototype.setupBackground = function() {
      this.background = new Kinetic.Layer();
      this.grid();
      return this.stage.add(this.background);
    };

    EasyNote.prototype.setupCanvas = function() {
      var cnv, offsetX, offsetY,
        _this = this;
      this.canvas = new Kinetic.Layer();
      window.canvas = this.canvas;
      this.stage.add(this.canvas);
      this.extendCanvas();
      cnv = this.canvas.getCanvas()._canvas;
      offsetX = cnv.getBoundingClientRect().left;
      offsetY = cnv.getBoundingClientRect().top;
      $(cnv).on('mousedown', function(event) {
        return _this.canvas.beginLine(event.pageX - offsetX, event.pageY - offsetY);
      });
      $(cnv).on('mousemove', function(event) {
        var offset;
        offset = $(event.currentTarget).offset();
        return _this.canvas.drawLine(event.pageX - offsetX, event.pageY - offsetY);
      });
      $(cnv).on('mouseup', function() {
        return _this.canvas.endLine();
      });
      return $(cnv).click(function() {
        return _this.canvas.drawPoint(event.pageX - offsetX, event.pageY - offsetY);
      });
    };

    EasyNote.prototype.extendCanvas = function() {
      this.canvas.drawing = false;
      this.canvas.context = this.canvas.getCanvas()._canvas.getContext('2d');
      this.canvas.penColor = 'black';
      this.canvas.penSize = '5';
      this.canvas.context.lineCap = 'round';
      this.canvas.context.lineJoin = 'round';
      this.canvas.context.strokeStyle = this.canvas.penColor;
      this.canvas.context.lineWidth = this.canvas.penSize;
      this.canvas.beginLine = function(x, y) {
        this.drawing = true;
        this.context.beginPath();
        return this.context.moveTo(x, y);
      };
      this.canvas.drawLine = function(x, y) {
        if (!this.drawing) {
          return;
        }
        this.context.lineTo(x, y);
        return this.context.stroke();
      };
      this.canvas.endLine = function() {
        return this.drawing = false;
      };
      this.canvas.drawPoint = function(x, y) {
        return this.context.fillRect(x, y, 5, 5);
      };
      this.canvas.startErasing = function() {
        this.context.globalCompositeOperation = 'destination-out';
        return this.context.strokeStyle = 'rgba(0,0,0,1)';
      };
      return this.canvas.startDrawing = function() {
        this.context.globalCompositeOperation = 'source-over';
        return this.context.strokeStyle = this.penColor;
      };
    };

    EasyNote.prototype.makeRule = function(coord, horizontal) {
      points;
      var points;
      if (horizontal) {
        points = [0, coord, this.WIDTH, coord];
      } else {
        points = [coord, 0, coord, this.HEIGHT];
      }
      return new Kinetic.Line({
        points: points,
        stroke: 'blue',
        strokeWidth: 1
      });
    };

    EasyNote.prototype.grid = function() {
      this.background.clear();
      return this.makeRules('both');
    };

    EasyNote.prototype.makeRules = function(kind) {
      var line, lines, x, y, _i, _j, _k, _len, _ref, _ref1, _ref2, _ref3, _results;
      lines = [];
      if (kind === "horizontal" || kind === "both") {
        for (y = _i = 0, _ref = this.HEIGHT, _ref1 = this.LINE_SPACE; _ref1 > 0 ? _i <= _ref : _i >= _ref; y = _i += _ref1) {
          lines.push(this.makeRule(y, true));
        }
      }
      if (kind === "vertical" || kind === "both") {
        for (x = _j = 0, _ref2 = this.WIDTH, _ref3 = this.LINE_SPACE; _ref3 > 0 ? _j <= _ref2 : _j >= _ref2; x = _j += _ref3) {
          lines.push(this.makeRule(x, false));
        }
      }
      _results = [];
      for (_k = 0, _len = lines.length; _k < _len; _k++) {
        line = lines[_k];
        _results.push(this.background.add(line));
      }
      return _results;
    };

    EasyNote.prototype.redraw = function() {
      this.stage = null;
      this.setupStage();
      return this.stage.add(this.background);
    };

    return EasyNote;

  })();

}).call(this);
